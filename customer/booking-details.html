<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Details - TES Real Estate</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="page-wrapper">
        <div class="header">
            <div class="header-content">
                <a href="/customer/my-bookings.html" style="text-decoration: none; font-size: 1.5rem;">‚Äπ</a>
                <h1 class="header-title">Booking Details</h1>
                <div></div>
            </div>
        </div>
        
        <div class="content-area">
            <div id="bookingDetails"></div>
        </div>
        
        <nav class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="/customer/dashboard.html" class="nav-item">
                    <div class="nav-icon">üè†</div>
                    <div class="nav-label">Home</div>
                </a>
                <a href="/customer/my-bookings.html" class="nav-item active">
                    <div class="nav-icon">üìÖ</div>
                    <div class="nav-label">Bookings</div>
                </a>
                <a href="/customer/book-appointment.html" class="nav-item">
                    <div class="nav-icon">‚ûï</div>
                    <div class="nav-label">Book</div>
                </a>
                <a href="/customer/profile.html" class="nav-item">
                    <div class="nav-icon">üë§</div>
                    <div class="nav-label">Profile</div>
                </a>
            </div>
        </nav>
    </div>
    
    <script src="/js/utils.js"></script>
    <script src="/js/data.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/customer.js"></script>
    <script>
        const currentUser = requireAuth('customer');
        if (!currentUser) return;
        
        const urlParams = new URLSearchParams(window.location.search);
        const appointmentId = parseInt(urlParams.get('id'));
        
        if (!appointmentId) {
            window.location.href = '/customer/my-bookings.html';
            return;
        }
        
        const details = getAppointmentDetails(appointmentId);
        
        if (!details || details.customerId !== currentUser.id) {
            window.location.href = '/customer/my-bookings.html';
            return;
        }
        
        const canCancel = details.status !== 'completed' && details.status !== 'cancelled';
        const canReview = canReviewAppointment(appointmentId, currentUser.id);
        
        document.getElementById('bookingDetails').innerHTML = `
            <div class="card">
                <div style="text-align: center; margin-bottom: 2rem;">
                    ${getStatusBadge(details.status)}
                    <p class="text-gray text-sm" style="margin-top: 0.5rem;">
                        Booking ID: ${details.bookingId}
                    </p>
                </div>
                
                <h3>Property Details</h3>
                <div class="list-item">
                    <div>
                        <strong>${details.property.name}</strong>
                        <p class="text-gray" style="margin: 0.25rem 0 0 0;">
                            ${details.property.type}<br>
                            ${formatCurrency(details.property.price)}<br>
                            üìç ${details.property.location}
                        </p>
                    </div>
                </div>
                
                <h3 style="margin-top: 1.5rem;">Appointment Details</h3>
                <div class="list-item">
                    <div style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Date:</strong>
                            <span>${formatDate(details.date)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Time:</strong>
                            <span>${details.time}</span>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 1.5rem;">Agent Information</h3>
                <div class="list-item">
                    <div class="avatar">${getInitials(details.agent.name)}</div>
                    <div style="flex: 1;">
                        <strong>${details.agent.name}</strong>
                        <p class="text-gray" style="margin: 0.25rem 0 0 0;">
                            ‚≠ê ${details.agent.rating.toFixed(1)}<br>
                            üìû ${details.agent.phone}
                        </p>
                    </div>
                </div>
                
                ${details.notes ? `
                    <h3 style="margin-top: 1.5rem;">Special Requests</h3>
                    <div class="info-box">
                        <p style="margin: 0;">${details.notes}</p>
                    </div>
                ` : ''}
                
                <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                    ${canReview ? `
                        <a href="/customer/leave-review.html?id=${appointmentId}" class="btn btn-primary btn-block">
                            Leave a Review
                        </a>
                    ` : ''}
                    ${canCancel ? `
                        <button onclick="handleCancel()" class="btn btn-danger btn-block">
                            Cancel Appointment
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        
        window.handleCancel = function() {
            showModal(
                'Cancel Appointment',
                'Are you sure you want to cancel this appointment?',
                () => {
                    const result = cancelAppointment(appointmentId, currentUser.id);
                    if (result.success) {
                        showSuccessAlert('Appointment cancelled successfully');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showErrorAlert(result.message);
                    }
                }
            );
        };
    </script>
</body>
</html>
